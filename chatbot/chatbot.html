<!DOCTYPE html>
<html lang="en">

<head>
	<title>convForm - example</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/jquery.convform.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="css/demo.css">
	<style>
		/* Style the language selector properly */
		#languageChange {
			position: absolute;
			top: 10px;
			left: 10px;
			z-index: 1000;
			padding: 5px 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			background: white;
			font-size: 12px;
		}
		
		/* Fix message positioning to prevent overlap with options */
		div.conv-form-wrapper div#messages div.message.to {
			margin-bottom: 15px !important;
		}
		
		/* Adjust message positioning when dragscroll options are present */
		div.conv-form-wrapper div.options.dragscroll ~ div#messages div.message.to {
			margin-top: -10px !important;
		}
		
		/* Ensure proper spacing during animations */
		div.conv-form-wrapper div.message {
			animation: slideTopFixed 0.15s ease;
		}
		
		@keyframes slideTopFixed {
			0% {
				opacity: 0;
				transform: translateY(10px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		/* Override the problematic slideTop animation */
		@keyframes slideTop {
			0% {
				opacity: 0;
				transform: translateY(10px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		/* Ensure options have proper spacing from messages */
		div.conv-form-wrapper div.options {
			margin-top: 10px;
		}
		
		/* Custom styling for options dragscroll container - only for subject selection */
		div.options.dragscroll.subject-selection {
			height: 180px !important;
			margin-top: 0 !important;
		}
		
		/* Adjust message positioning when dragscroll options are present for subject selection */
		div.conv-form-wrapper div.options.dragscroll.subject-selection ~ div#messages div.message.to {
			margin-top: -10px !important;
		}
		
		/* Increase padding-bottom for messages container during subject selection */
		div#messages.subject-selection {
			padding-bottom: 100px !important;
		}
		
		/* Custom styling for options dragscroll container - only for location selection */
		div.options.dragscroll.location-selection {
			height: 110px !important;
			margin-top: 0 !important;
		}
		
		/* Increase padding-bottom for messages container during location selection */
		div#messages.location-selection {
			padding-bottom: 25px !important;
		}
		
		/* Ensure no overflow CSS text appears */
		body {
			overflow-x: hidden;
		}
		
		/* Clean up any debug content */
		* {
			line-height: normal;
		}
		
		/* Make the start button text bold and increase border thickness */
		.option {
			font-weight: bold !important;
			border-width: 3px !important;
		}
		
		/* Mobile font size adjustments */
		@media (max-width: 768px) {
			/* Increase font size for messages on mobile */
			div.conv-form-wrapper div.message {
				font-size: 18px !important;
				line-height: 1.4 !important;
			}
			
			/* Increase font size for options on mobile */
			div.conv-form-wrapper div.options .option {
				font-size: 16px !important;
				/* padding: 12px 16px !important; */
			}
			
			/* Increase font size for input field on mobile */
			div.conv-form-wrapper input[type="text"],
			div.conv-form-wrapper textarea {
				font-size: 16px !important;
			}
			
			/* Increase font size for submit button on mobile */
			div.conv-form-wrapper .submit {
				font-size: 16px !important;
			}
		}
	</style>
</head>

<body>
	<select name="" id="languageChange">
		<option value="en">English</option>
		<option value="it" selected>Italian</option>
	</select>
	<section id="demo">
		<div class="vertical-align">
			<div class="container">
				<div class="row">
					<div class="col-sm-6 col-sm-offset-3 col-xs-offset-0">
						<div class="card no-border">
							<div id="chat">
								<form action="" id="form-chatbot" method="GET" class="hidden">
									<select id="question-data-it"
										data-conv-question="Ciao! In meno di 1 minuto troviamo un tutor giusto per Te gratuitamente. Rispondi a 3 semplici domande e riceverai il contatto del tutor. ðŸ‘‡"
										name="first-question">
										<option value="INIZIAMO!">INIZIAMO!</option>
									</select>
									<select id="question-data-en" style="display: none;"
										data-conv-question="Hi! In less than a minute, we'll find the right tutor for you for free. Answer 3 simple questions and you'll receive the tutor's contact. Click below. ðŸ‘‡"
										name="first-question">
										<option value="letsstart">LET'S START</option>
									</select>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<script type="text/javascript" src="js/jquery-1.12.3.min.js"></script>
	<script type="text/javascript" src="js/autosize.min.js"></script>
	<script type="text/javascript" src="js/jquery.convform.js"></script>



	<script>
		$('#languageChange').on('change', function () {
			if ($('#languageChange').val() == 'it') {
				// Show Italian, hide English
				$('#question-data-it').show();
				$('#question-data-en').hide();
	
				$('.message:first-child').html('')
				$('.message:first-child').html('Ciao! In meno di 1 minuto troviamo un tutor giusto per Te gratuitamente. Rispondi a 3 semplici domande e riceverai il contatto del tutor. Clicca qui sotto ðŸ‘‡')
				$("#convForm .option:first-child").html('INIZIAMO!')
				$("#convForm .option:first-child").text('INIZIAMO!')

				$("#convForm .option:first-child").val('INIZIAMO!')
				// Set Italian placeholder text
				if ($("#userInput").attr("placeholder") == "Select an option" || $("#userInput").attr("placeholder") == "seleziona un'opzione") {
					$("#userInput").attr("placeholder", "Seleziona un'opzione");
				} else {
					// During loading/transitions, show "..." instead of "digita qui"
					$("textarea#userInput").attr("placeholder", "...");
				}
				$(".submit").html('invia');

			} else {
				// Show English, hide Italian
				$('#question-data-en').show();
				$('#question-data-it').hide();
				
				$('.message:first-child').html('')
				$('.message:first-child').html('Hi! In less than a minute, we\'ll find the right tutor for you for free. Answer 3 simple questions and you\'ll receive the tutor\'s contact. Click below. ðŸ‘‡')
				$("#convForm .option:first-child").html('Let\'s start')
				$(".option:first-child").html('Let\'s start')
				// Set English placeholder text
				if ($("#userInput").attr("placeholder") == "seleziona un'opzione" || $("#userInput").attr("placeholder") == "Select an option") {
					$("#userInput").attr("placeholder", "Select an option");
				} else {
					// During loading/transitions, show "..." instead of "Type Here"
					$("textarea#userInput").attr("placeholder", "...");
				}
				$(".submit").html('Send');
			}
		});
		jQuery(function ($) {
			const baseUrl = 'https://tvtorbackend.onrender.com/api/v1';
			var userData = {};
			var isAssignTutor = true;
			var isAssignTutor_check = true;
			var setIntervalTime;
			var newQuestion = '';
			var count = 3;
			var lastNext = 0;
			let notificationId = ""
			var url = `${baseUrl}/question`
			var convForm = $('#chat').convform({
				selectInputStyle: 'disable',
				selectInputDisabledText: "seleziona un'opzione", // Set Italian placeholder by default
				eventList: {
					onInputSubmit: function (convState, ready) {
						get_question(convState, ready);
					// Remove name validation since we skip name question
						if (convState.current.input.name == "age") {
							$("#chat").removeClass("danger");
						}
					}
				}
			});

			// Monitor subject selections to update placeholder
			$(document).on('click', '.option', function() {
				// Disable auto-click if user clicks manually
				autoClickExecuted = true;
				
				// Check if we're in subject selection mode
				if ($(this).closest('.conv-form-wrapper').find('input[name="subject"]').length > 0) {
					setTimeout(function() {
						// Count selected subjects
						var selectedSubjects = $('.option.selected').length;
						
						if (selectedSubjects >= 2) {
							// Remove placeholder when 2 subjects are selected
							$("#userInput").attr("placeholder", "");
						} else if (selectedSubjects === 1) {
							// Show "Seleziona fino a 2 materie" when 1 is selected
							if ($('#languageChange').val() == 'it') {
								$("#userInput").attr("placeholder", "Seleziona fino a 2 materie");
							} else {
								$("#userInput").attr("placeholder", "Select up to 2 subjects");
							}
						}
					}, 100);
				}
			});

			// Initialize Italian language by default
			setTimeout(function() {
				$('#languageChange').val('it').trigger('change');
				
				// Ensure the placeholder is set to Italian on first load
				setTimeout(function() {
					if ($("#userInput").length && $("#userInput").attr("placeholder") === "Select an option") {
						$("#userInput").attr("placeholder", "seleziona un'opzione");
					}
				}, 100);
			}, 500);

			// Auto-click the "INIZIAMO!" button after convForm is fully loaded
			var autoClickExecuted = false;
			setTimeout(function() {
				// Wait for the convForm to be fully rendered
				var checkButton = setInterval(function() {
					var button = $(".option").first();
					if (button.length > 0 && button.is(':visible') && !autoClickExecuted) {
						// Check if user has already interacted
						if (!$('.message').length || $('.message').length === 1) {
							clearInterval(checkButton);
							button.click();
							autoClickExecuted = true;
							console.log('Auto-clicked the start button');
						}
					}
				}, 20);
				
				// Stop trying after 1 second
				setTimeout(function() {
					clearInterval(checkButton);
				}, 6000);
			}, 6000);

			function locationCheck() {
				var checkLocationUrl = `${baseUrl}/getTutorsLocation`;
				jQuery.ajax({
					url: checkLocationUrl, async: true, method: 'post', data: userData, success: function (result) {
						if (result.statusCode == 404) {
							var que = "There is no tutor are available on this location";
							$('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
							return false;
						} else {
							return true;
						}
					}
				})
			}

			function checkTutorAssignOrNot(convState, ready) {
				console.log('Checking tutor assignment...');
				var checkLocationUrl = `${baseUrl}/checkTutorAssignOrNot/${userData.email}`;
				if (isAssignTutor) {
					jQuery.ajax({
						url: checkLocationUrl, async: true, method: 'get', data: userData, success: function (result) {
							console.log('Tutor assignment check result:', result);
							if (result.data && isAssignTutor && isAssignTutor_check) {
								isAssignTutor_check = false
								assignTutor(convState, ready);
							}
						}
					})
				}
			}

			function sendToFormspree(userData, phoneNumber) {
				// Prepare data for Formspree
				var formData = {
					phone_number: phoneNumber,
					subjects: Array.isArray(userData.subject) ? userData.subject.join(', ') : userData.subject,
					location: userData.location,
					school_year: userData.age,
					email: userData.email,
					tutor_name: userData.tutor_name || '',
					tutor_surname: userData.tutor_surname || '',
					tutor_email: userData.tutor_email || '',
					tutor_mobile: userData.tutor_mobile || '',
					tutor_description: userData.tutor_description || ''
				};
				
				// Send to Formspree
				jQuery.ajax({
					url: 'https://formspree.io/f/xwprwgvw',
					method: 'POST',
					data: formData,
					success: function(response) {
						console.log('Data sent to Formspree successfully');
					},
					error: function(xhr, status, error) {
						console.log('Error sending to Formspree:', error);
					}
				});
			}

			function assignTutor(convState, ready) {
				var assignTutorUrl = `${baseUrl}/getStudentTutor`;
				jQuery.ajax({
					url: assignTutorUrl, async: true, method: 'post', data: userData, success: function (result) {
						isAssignTutor = false;
						clearInterval(setIntervalTime);
						var que
						if ($('#languageChange').val() == 'en') {
							que = "There is no tutor available right now. Thank you!";
						} else if ($('#languageChange').val() == 'it') {
							que = "Non ci sono tutor disponibili al momento.";
						}
						let image
						let name
						let surname
						let contactMessage = '';
						
						if (result.success) {
							name = result.data.tutor.name;
							surname = result.data.tutor.surname;
							const email = result.data.tutor.email;
							const mobileNumber = result.data.tutor.mobileNumber;
							const profileImage = result.data.tutor.imageUrl;
							const description = result.data.tutor.description;
							notificationId = result.data.notificationId;
							image = profileImage
							
							// Store tutor information in userData for Formspree submission
							userData.tutor_name = name;
							userData.tutor_surname = surname;
							userData.tutor_email = email;
							userData.tutor_mobile = mobileNumber;
							userData.tutor_description = description;
							
							// Set tutor description
							if ($('#languageChange').val() == 'en') {
								que = description;
								contactMessage = `You can now contact the tutor at the number ${mobileNumber}. Have a nice lesson!`;
							} else if ($('#languageChange').val() == 'it') {
								que = description;
								contactMessage = `Ora puoi contattare il tutor al numero ${mobileNumber}. Buona lezione!`;
							}
						}
						
						// Show tutor profile
						if (image) {
							$('#messages').append('<div class="message to ready image_size"><img src=' + image + ' alt="" width="70" height="70"><figcaption>' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);

							// get_question(convState, ready);
						} else {
							$('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);
							// get_question(convState, ready);
						}
						
						// Show phone number collection step before contact message
						if (result.success) {
							setTimeout(() => {
								var phoneQuestion = $('#languageChange').val() == 'it' ? 
									'Inserisci il tuo numero di telefono per essere contattato dal tutor:' : 
									'Enter your phone number to be contacted by the tutor:';
								
								$('#messages').append('<div class="message to ready">' + phoneQuestion + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);
								
								// Create phone input field
								convState.current.next = convState.newState({
									type: 'text',
									name: 'phone_number',
									questions: [phoneQuestion],
									pattern: '^[+]?[0-9\s\-\(\)]{8,15}$' // Basic phone number validation
								});
								
								// Set placeholder for phone input
								setTimeout(function () {
									$("#userInput").attr("placeholder", $('#languageChange').val() == 'it' ? 'Inserisci il tuo numero' : 'Enter your phone number');
								}, 100);
								
								ready();
							}, 1500);
						} else {
							// No tutor found, end conversation and disable input
							setTimeout(() => {
								// Disable input when no tutor is found
								$('#userInput').prop('disabled', true);
								$('.submit').prop('disabled', true);
								$('#userInput').attr('placeholder', $('#languageChange').val() == 'it' ? 'Nessun tutor disponibile' : 'No tutor available');
								$('#userInput').css({
									'background-color': '#f5f5f5',
									'color': '#888',
									'cursor': 'not-allowed'
								});
								$('.submit').css({
									'background-color': '#ccc',
									'cursor': 'not-allowed'
								});
								
								// End the conversation without calling ready
							}, 1000);
						}
					}
				});
			}

			function get_question(convState, ready) {
				if (convState.current.answer.value === 'end') {
					setTimeout(ready, Math.random() * 500 + 100);
				} else {
					if (Array.isArray(convState.current.answer)) {
						// For multiple selections (like subjects), send as array instead of comma-separated string
						var answer = convState.current.answer;
						userData[convState.current.input.name] = answer;
					}
					else {
						var answer = convState.current.answer.text;
						userData[convState.current.input.name] = answer;
					}
					
					// Handle phone number collection and Formspree submission
					if (convState.current.input.name === 'phone_number') {
						// Send data to Formspree
						sendToFormspree(userData, answer);
						
						// Show contact message after phone collection
						setTimeout(() => {
							var contactMessage = $('#languageChange').val() == 'it' ? 
								`Ora puoi contattare il tutor al numero ${userData.tutor_mobile || 'il numero che ti Ã¨ stato fornito'}. Buona lezione!` : 
								`You can now contact the tutor at the number ${userData.tutor_mobile || 'the number provided to you'}. Have a nice lesson!`;
							
							$('#messages').append('<div class="message to ready">' + contactMessage + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);
							
							// Disable input after successful tutor assignment
							$('#userInput').prop('disabled', true);
							$('.submit').prop('disabled', true);
							$('#userInput').attr('placeholder', $('#languageChange').val() == 'it' ? 'Conversazione terminata' : 'Conversation ended');
							$('#userInput').css({
								'background-color': '#f5f5f5',
								'color': '#888',
								'cursor': 'not-allowed'
							});
							$('.submit').css({
								'background-color': '#ccc',
								'cursor': 'not-allowed'
							});
						}, 1000);
						
						// Don't continue with normal flow
						return;
					}
					
					// Debug: log what we're saving
					console.log('Saving answer:', {
						fieldName: convState.current.input.name,
						answer: convState.current.answer,
						userData: userData
					});
					var queryString = '';
					// Generate email without name since we skip name question
					if (userData.age && userData.subject && !userData.website) {
						var d = new Date();
						var n = d.getTime();
						userData.email = n + 'student' + '@gmail.com'
					}
					
					// Stop after age question (question 5) - we have all needed info
					if (userData.age && userData.subject && userData.location) {
						// We have all required data, show processing message and start tutor assignment
						console.log('All data collected, starting tutor assignment process...');
						
						// Create notification by making a direct API call
						console.log('Creating notification with all data:', userData);
						jQuery.ajax({
							url: `${baseUrl}/question`, 
							data: { 
								language: $('#languageChange').val(), 
								question: count, 
								email: userData.email, 
								subject: userData.subject, 
								location: userData.location, 
								mobilenumber: userData.mobilenumber, 
								age: userData.age, 
								website: userData.website, 
								notificationId: notificationId 
							}, 
							async: false, 
							method: 'post',
							success: function (result) {
								console.log('Notification created successfully');
							}
						});
						
						// Show processing message
						var processingMessage = $('#languageChange').val() == 'it' ? 
							'Grazie! Stiamo cercando il miglior tutor per te. Attendi per favore...' : 
							'Thank you! We\'re finding the best tutor for you. Please wait...';
						
						$('#messages').append('<div class="message to ready">' + processingMessage + '</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
						
						// Start tutor assignment process immediately
						setTimeout(() => {
							if (isAssignTutor) {
								checkTutorAssignOrNot(convState, ready);
							}
						}, 1000);
						
						// Also set up the interval as backup
						setIntervalTime = setInterval(() => {
							if (isAssignTutor) {
								checkTutorAssignOrNot(convState, ready);
							}
						}, 2000);
						setTimeout(function () {
							clearInterval(setIntervalTime);
							// If no tutor assignment after 30 seconds, show timeout message
							if (isAssignTutor) {
								isAssignTutor = false;
								var timeoutMessage = $('#languageChange').val() == 'it' ? 
									'Non ci sono tutor disponibili al momento. Scrivici al +39 3485804824!' : 
									'No tutors are available right now. Contact us at +393485804824!';
								
								$('#messages').append('<div class="message to ready">' + timeoutMessage + '</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
								
								// Disable input after timeout
								$('#userInput').prop('disabled', true);
								$('.submit').prop('disabled', true);
								$('#userInput').attr('placeholder', $('#languageChange').val() == 'it' ? 'Richiesta inviata' : 'Request sent');
								$('#userInput').css({
									'background-color': '#f5f5f5',
									'color': '#888',
									'cursor': 'not-allowed'
								});
								$('.submit').css({
									'background-color': '#ccc',
									'cursor': 'not-allowed'
								});
							}
						}, 30000); // 30 seconds timeout
						
						// Don't call ready() - this prevents the chatbot from continuing to look for questions
						return;
					}
					
					// Skip questions after age (question 5) - tutor assignment will handle the end
					if (count >= 6) {
						// Don't fetch question 7 or higher, let tutor assignment handle the conversation end
						// Just return without creating an end state - let tutor assignment handle it
						setTimeout(ready, 500);
						return;
					}
					
					for (var key in userData) {
						if (userData.hasOwnProperty(key)) {
							queryString += '&' + key + '=' + userData[key];
						}
					}
					
					// Debug: log userData to see what we're sending
					console.log('Sending data:', userData);
					console.log('Count:', count);
					
					jQuery.ajax({
						url, data: { language: $('#languageChange').val(), question: count, email: userData.email, subject: userData.subject, location: userData.location, mobilenumber: userData.mobilenumber, age: userData.age, website: userData.website, notificationId: notificationId }, async: false, method: 'post', 
						success: function (result) {
							var qData = result.data.data;
							if (qData[0].type == "select" && qData[0].languageCode == "it") {
								setTimeout(function () {
									// Check if this is the subject selection question
									if (qData[0].title === 'subject') {
										$("#userInput").attr("placeholder", "Seleziona fino a 2 materie");
										// Add subject-selection class for custom styling
										$("div.options.dragscroll").addClass("subject-selection");
										$("#messages").addClass("subject-selection");
										// Remove location-selection class
										$("div.options.dragscroll").removeClass("location-selection");
										$("#messages").removeClass("location-selection");
									} else if (qData[0].title === 'location') {
										$("#userInput").attr("placeholder", "seleziona un'opzione");
										// Add location-selection class for custom styling
										$("div.options.dragscroll").addClass("location-selection");
										$("#messages").addClass("location-selection");
										// Remove subject-selection class
										$("div.options.dragscroll").removeClass("subject-selection");
										$("#messages").removeClass("subject-selection");
									} else {
										$("#userInput").attr("placeholder", "seleziona un'opzione");
										// Remove all custom classes for normal styling
										$("div.options.dragscroll").removeClass("subject-selection location-selection");
										$("#messages").removeClass("subject-selection location-selection");
									}
								}, 2000);
							}
							else if (qData[0].type == "select" && qData[0].languageCode == "en") {
								setTimeout(function () {
									// Check if this is the subject selection question
									if (qData[0].title === 'subject') {
										$("#userInput").attr("placeholder", "Select up to 2 subjects");
										// Add subject-selection class for custom styling
										$("div.options.dragscroll").addClass("subject-selection");
										$("#messages").addClass("subject-selection");
										// Remove location-selection class
										$("div.options.dragscroll").removeClass("location-selection");
										$("#messages").removeClass("location-selection");
									} else if (qData[0].title === 'location') {
										$("#userInput").attr("placeholder", "Select an option");
										// Add location-selection class for custom styling
										$("div.options.dragscroll").addClass("location-selection");
										$("#messages").addClass("location-selection");
										// Remove subject-selection class
										$("div.options.dragscroll").removeClass("subject-selection");
										$("#messages").removeClass("subject-selection");
									} else {
										$("#userInput").attr("placeholder", "Select an option");
										// Remove all custom classes for normal styling
										$("div.options.dragscroll").removeClass("subject-selection location-selection");
										$("#messages").removeClass("subject-selection location-selection");
									}
								}, 2000);

							}
							else if (qData[0].type == "text" && qData[0].languageCode == "en") {
								setTimeout(function () {
									// Only show "Type Here" for age question, otherwise show "..."
									if (qData[0].title === 'age') {
										$("#userInput").attr("placeholder", "Type Here");
									} else {
										$("#userInput").attr("placeholder", "...");
									}
								}, 5);

							}
							else if (qData[0].type == "text" && qData[0].languageCode == "it") {
								setTimeout(function () {
									// Only show "digita qui" for age question, otherwise show "..."
									if (qData[0].title === 'age') {
										$("#userInput").attr("placeholder", "digita qui");
									} else {
										$("#userInput").attr("placeholder", "...");
									}
								}, 5);
							} else if (qData[0].title == "contacting_tutor" && qData[0].languageCode == "it") {
								setTimeout(function () {
									$("#userInput").attr("placeholder", "seleziona un'opzione");
								}, 2000);
							}

							var pattern = '';
							for (var i = 0; i < qData.length; i++) {
								if (qData[i].title == 'email') {
									pattern = "^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$";
								}
								newQuestion = qData[i].question;
								count = qData[i].question_num;
								var questionTitle = qData[i].title;
								newQuestion = newQuestion.replace("{name}", answer);

								if (qData[i].no_answer == 1) {
									convState.current.next = convState.newState({
										type: 'text',
										noAnswer: true,
										name: questionTitle,
										questions: [newQuestion],
									});
									lastNext = 1;
								} else {
									if (lastNext == 1) {
										lastNext = 0;
										if (qData[i].type == 'text') {
											convState.current.next.next = convState.newState({
												type: 'text',
												name: questionTitle,
												pattern: pattern,
												questions: [newQuestion],
											});
										} else {
											convState.current.next.next = convState.newState({
												type: 'select',
												name: questionTitle,
												questions: [newQuestion],
												answers: qData[i].options,
												multiple: questionTitle === 'subject', // Enable multiple selection for subjects
												selected: questionTitle === 'subject' ? [] : ""
											});
										}
									} else {
										if (qData[i].type == 'text') {
											convState.current.next = convState.newState({
												type: 'text',
												pattern: pattern,
												name: questionTitle,
												questions: [newQuestion],
											});

										} else {
											answersOption = qData[i].options;
											convState.current.next = convState.newState({
												type: 'select',
												name: questionTitle,
												questions: [newQuestion],
												answers: answersOption,
												multiple: questionTitle === 'subject', // Enable multiple selection for subjects
												selected: questionTitle === 'subject' ? [] : ""
											});
										}
									}
								}
							}
						}
					});
					setTimeout(ready, Math.random() * 500 + 500);
				}
				count++;
			}
		});
	</script>
</body>

</html>
