<!DOCTYPE html>
<html lang="en">

<head>
    <title>convForm - example</title>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
    
    <!-- Instant mobile redirect - must be at the very top -->
    <script>
        // Redirect to full chatbot page if accessed from mobile and not already in iframe
        if (window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // Check if we're in an iframe (desktop widget) or direct access (mobile redirect)
            if (window === window.top) {
                // We're not in an iframe, so this is a direct mobile access - stay here
                // This is the final destination for mobile users
            } else {
                // We're in an iframe on desktop, don't redirect
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/jquery.convform.css">
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
          crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/demo.css">
    <style>
        /* Style the language selector properly */
        #languageChange {
           position: absolute;
           top: 10px;
           left: 10px;
           z-index: 1000;
           padding: 5px 10px;
           border: 1px solid #ddd;
           border-radius: 5px;
           background: white;
           font-size: 12px;
        }

        /* Fix message positioning to prevent overlap with options */
        div.conv-form-wrapper div#messages div.message.to {
           margin-bottom: 15px !important;
        }

        /* Adjust message positioning when dragscroll options are present */
        div.conv-form-wrapper div.options.dragscroll ~ div#messages div.message.to {
           margin-top: -10px !important;
        }

        /* Ensure proper spacing during animations */
        div.conv-form-wrapper div.message {
           animation: slideTopFixed 0.15s ease;
        }

        @keyframes slideTopFixed {
           0% {
              opacity: 0;
              transform: translateY(10px);
           }
           100% {
              opacity: 1;
              transform: translateY(0);
           }
        }

        /* Override the problematic slideTop animation */
        @keyframes slideTop {
           0% {
              opacity: 0;
              transform: translateY(10px);
           }
           100% {
              opacity: 1;
              transform: translateY(0);
           }
        }

        /* Ensure options have proper spacing from messages */
        div.conv-form-wrapper div.options {
           margin-top: 10px;
        }

        /* Custom styling for options dragscroll container - only for subject selection */
        div.options.dragscroll.subject-selection {
           height: 180px !important;
           margin-top: 0 !important;
        }

        /* Adjust message positioning when dragscroll options are present for subject selection */
        div.conv-form-wrapper div.options.dragscroll.subject-selection ~ div#messages div.message.to {
           margin-top: -10px !important;
        }

        /* Increase padding-bottom for messages container during subject selection */
        div#messages.subject-selection {
           padding-bottom: 100px !important;
        }

        /* Custom styling for options dragscroll container - only for location selection */
        div.options.dragscroll.location-selection {
           height: 0 !important;
           margin-top: 0 !important;
        }
        /* Expand location options only when there are option items */
        div.options.dragscroll.location-selection:has(.option) {
           height: 110px !important;
        }

        /* Increase padding-bottom for messages container during location selection */
        div#messages.location-selection {
           padding-bottom: 25px !important;
        }

        /* Ensure no overflow CSS text appears */
        body {
           overflow-x: hidden;
        }

        /* Clean up any debug content */
        * {
           line-height: normal;
        }

        /* Make the start button text bold and increase border thickness */
        .option {
           font-weight: bold !important;
           border-width: 3px !important;
        }

        /* Mobile header styles */
        .mobile-header {
            display: none;
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            color: white;
            padding: 16px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .mobile-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .mobile-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 400;
            font-style: italic;
        }
        
        .mobile-header-logo {
            height: 30px;
            margin-right: 10px;
        }
        
        .mobile-header-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .mobile-header-close:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* Mobile font size adjustments */
        @media (max-width: 768px) {
           .mobile-header {
               display: block;
           }
           
           /* Add top padding to body to account for fixed header */
           body {
               padding-top: 70px;
           }
           
           /* Move language selector down on mobile */
           #languageChange {
               top: 83px !important;
           }
           
           /* Set minimum height for demo section on mobile */
           section#demo {
               min-height: 84vh;
           }
           
           /* Add margin top to first message on mobile */
           div.conv-form-wrapper div.message.to.ready:first-child {
               margin-top: 130px !important;
           }
           
           /* Increase font size for messages on mobile */
           div.conv-form-wrapper div.message {
              font-size: 18px !important;
              line-height: 1.4 !important;
           }

           /* Increase font size for options on mobile */
           div.conv-form-wrapper div.options .option {
              font-size: 16px !important;
              /* padding: 12px 16px !important; */
           }

           /* Increase font size for input field on mobile */
           div.conv-form-wrapper input[type="text"],
           div.conv-form-wrapper textarea {
              font-size: 16px !important;
           }

           /* Increase font size for submit button on mobile */
           div.conv-form-wrapper .submit {
              font-size: 16px !important;
           }
        }
    </style>


</head>

<body>
<!-- Mobile Header -->
<div class="mobile-header">
    <div class="mobile-header-content">
        <div style="display: flex; align-items: center;">
            <img src="../media/logo_trim.png" alt="TVTOR" class="mobile-header-logo">
            <h3>TVTOR - Trova il tuo tutor a Treviso</h3>
        </div>
        <button class="mobile-header-close" onclick="window.location.href='../index.html'">&times;</button>
    </div>
</div>

<select name="" id="languageChange">
    <option value="en">English</option>
    <option value="it" selected>Italiano</option>
</select>
<section id="demo">
    <div class="vertical-align">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3 col-xs-offset-0">
                    <div class="card no-border">
                        <div id="chat">
                            <form action="" id="form-chatbot" method="GET" class="hidden">
                                <select id="question-data-it"
                                        data-conv-question="Ciao! ðŸ‘‹ In meno di 1 minuto troviamo un tutor giusto per Te gratuitamente. ðŸŽ“ Rispondi a 3 semplici domande e riceverai il contatto del tutor. ðŸ‘‡"
                                        name="first-question">
                                    <option value="INIZIAMO!">INIZIAMO!</option>
                                </select>
                                <select id="question-data-en" style="display: none;"
                                        data-conv-question="Hi! In less than a minute, we'll find the right tutor for you for free. Answer 3 simple questions and you'll receive the tutor's contact. Click below. ðŸ‘‡"
                                        name="first-question">
                                    <option value="letsstart">LET'S START</option>
                                </select>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script type="text/javascript" src="js/jquery-1.12.3.min.js"></script>
<script type="text/javascript" src="js/autosize.min.js"></script>
<script type="text/javascript" src="js/jquery.convform.js"></script>

<script>
    $('#languageChange').on('change', function () {
       if ($('#languageChange').val() == 'it') {
          $('#question-data-it').show();
          $('#question-data-en').hide();

          $('.message:first-child').html('')
          $('.message:first-child').html('Ciao! ðŸ‘‹ In meno di 1 minuto troviamo un tutor giusto per Te gratuitamente. ðŸŽ“ Rispondi a 3 semplici domande e riceverai il contatto del tutor. Clicca qui sotto ðŸ‘‡')
          $("#convForm .option:first-child").html('INIZIAMO!')
          $("#convForm .option:first-child").text('INIZIAMO!')

          $("#convForm .option:first-child").val('INIZIAMO!')
          if ($("#userInput").attr("placeholder") == "Select an option" || $("#userInput").attr("placeholder") == "seleziona un'opzione") {
             $("#userInput").attr("placeholder", "Seleziona un'opzione");
          } else {
             $("textarea#userInput").attr("placeholder", "...");
          }
          $(".submit").html('invia');

       } else {
          $('#question-data-en').show();
          $('#question-data-it').hide();

          $('.message:first-child').html('')
          $('.message:first-child').html('Hi! In less than a minute, we\'ll find the right tutor for you for free. Answer 3 simple questions and you\'ll receive the tutor\'s contact. Click below. ðŸ‘‡')
          $("#convForm .option:first-child").html('Let\'s start')
          $(".option:first-child").html('Let\'s start')
          if ($("#userInput").attr("placeholder") == "seleziona un'opzione" || $("#userInput").attr("placeholder") == "Select an option") {
             $("#userInput").attr("placeholder", "Select an option");
          } else {
             $("textarea#userInput").attr("placeholder", "...");
          }
          $(".submit").html('Send');
       }
    });

    jQuery(function ($) {
       const baseUrl = 'https://tvtorbackend.onrender.com/api/v1';
       var userData = {};
       var isAssignTutor = true;
       var isAssignTutor_check = true;
       var setIntervalTime;
       var newQuestion = '';
       var count = 3;
       var lastNext = 0;
       let notificationId = ""
       var url = `${baseUrl}/question`
       var convForm = $('#chat').convform({
          selectInputStyle: 'disable',
          selectInputDisabledText: "seleziona un'opzione",
          eventList: {
             onInputSubmit: function (convState, ready) {
                get_question(convState, ready);
                if (convState.current.input.name == "age") {
                   $("#chat").removeClass("danger");
                }
             }
          }
       });

       $(document).on('click', '.option', function() {
          autoClickExecuted = true;

          if ($(this).closest('.conv-form-wrapper').find('input[name="subject"]').length > 0) {
             setTimeout(function() {
                var selectedSubjects = $('.option.selected').length;

                if (selectedSubjects >= 2) {
                   $("#userInput").attr("placeholder", "");
                } else if (selectedSubjects === 1) {
                   if ($('#languageChange').val() == 'it') {
                      $("#userInput").attr("placeholder", "Seleziona fino a 2 materie");
                   } else {
                      $("#userInput").attr("placeholder", "Select up to 2 subjects");
                   }
                }
             }, 100);
          }
       });

       setTimeout(function() {
          $('#languageChange').val('it').trigger('change');

          setTimeout(function() {
             if ($("#userInput").length && $("#userInput").attr("placeholder") === "Select an option") {
                $("#userInput").attr("placeholder", "seleziona un'opzione");
             }
          }, 100);
       }, 500);

       var autoClickExecuted = false;
       setTimeout(function() {
          var checkButton = setInterval(function() {
             var button = $(".option").first();
             if (button.length > 0 && button.is(':visible') && !autoClickExecuted) {
                if (!$('.message').length || $('.message').length === 1) {
                   clearInterval(checkButton);
                   button.click();
                   autoClickExecuted = true;
                   console.log('Auto-clicked the start button');
                }
             }
          }, 20);

          setTimeout(function() {
             clearInterval(checkButton);
          }, 6000);
       }, 6000);

       function locationCheck() {
          var checkLocationUrl = `${baseUrl}/getTutorsLocation`;
          jQuery.ajax({
             url: checkLocationUrl, async: true, method: 'post', data: userData, success: function (result) {
                if (result.statusCode == 404) {
                   var que = "There is no tutor are available on this location";
                   $('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 600 }, 600);
                   return false;
                } else {
                   return true;
                }
             }
          })
       }

       function checkTutorAssignOrNot(convState, ready) {
          console.log('Checking tutor assignment...');
          var checkLocationUrl = `${baseUrl}/checkTutorAssignOrNot/${userData.email}`;
          if (isAssignTutor) {
             jQuery.ajax({
                url: checkLocationUrl, async: true, method: 'get', data: userData, success: function (result) {
                   console.log('Tutor assignment check result:', result);
                   if (result.data && isAssignTutor && isAssignTutor_check) {
                      isAssignTutor_check = false
                      assignTutor(convState, ready);
                   }
                }
             })
          }
       }

       function sendToFormspree(userData, phoneNumber) {
          var formData = {
             phone_number: phoneNumber,
             subjects: Array.isArray(userData.subject) ? userData.subject.join(', ') : userData.subject,
             location: userData.location,
             school_year: userData.age,
             email: userData.email,
             tutor_name: userData.tutor_name || '',
             tutor_surname: userData.tutor_surname || '',
             tutor_email: userData.tutor_email || '',
             tutor_mobile: userData.tutor_mobile || '',
             tutor_description: userData.tutor_description || ''
          };

          jQuery.ajax({
             url: 'https://formspree.io/f/xwprwgvw',
             method: 'POST',
             data: formData,
             success: function(response) {
                console.log('Data sent to Formspree successfully');
             },
             error: function(xhr, status, error) {
                console.log('Error sending to Formspree:', error);
             }
          });
       }

       function assignTutor(convState, ready) {
         var assignTutorUrl = `${baseUrl}/getStudentTutor`;
         jQuery.ajax({
             url: assignTutorUrl, async: true, method: 'post', data: userData, success: function (result) {
                 isAssignTutor = false;
                 clearInterval(setIntervalTime);
                 var que;
                 if ($('#languageChange').val() == 'en') {
                     que = "There is no tutor available right now. Thank you!";
                 } else if ($('#languageChange').val() == 'it') {
                     que = "Non ci sono tutor disponibili al momento.";
                 }
                 let image;
                 let name;
                 let surname;
                 let contactMessage = '';

                 if (result.success) {
                     name = result.data.tutor.name;
                     surname = result.data.tutor.surname;
                     const email = result.data.tutor.email;
                     const mobileNumber = result.data.tutor.mobileNumber;
                     const profileImage = result.data.tutor.imageUrl;
                     const description = result.data.tutor.description;
                     notificationId = result.data.notificationId;
                     image = profileImage;

                     userData.tutor_name = name;
                     userData.tutor_surname = surname;
                     userData.tutor_email = email;
                     userData.tutor_mobile = mobileNumber;
                     userData.tutor_description = description;
                           $('#messages .message').filter(function () {
      var txt = $(this).text().trim();
      return $(this).hasClass('typing') || $(this).hasClass('loading') || txt === '...';
   }).remove();
                     if ($('#languageChange').val() == 'en') {
                         que = description;
                         contactMessage = `You can now contact the tutor at the number ${mobileNumber}. Have a nice lesson!`;
                     } else if ($('#languageChange').val() == 'it') {
                         que = description;
                         contactMessage = `Ora puoi contattare il tutor al numero ${mobileNumber}. Buona lezione!`;
                     }
                 }

                 if (image) {
                     $('#messages').append('<div class="message to ready image_size"><img src="' + image + '" alt="" width="120" height="120"><figcaption>' + que + '</figcaption></div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);
                 } else {
                     $('#messages').append('<div class="message to ready">' + que + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);
                 }

                 setTimeout(() => {
                     var phoneQuestion = $('#languageChange').val() == 'it' ?
                         'Inserisci il tuo numero di telefono per essere contattato dal tutor:' :
                         'Enter your phone number to be contacted by the tutor:';

                     $('#messages').append('<div class="message to ready">' + phoneQuestion + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);

                     setTimeout(function () {
                         convState.current.next = convState.newState({
                             type: 'text',
                             name: 'phone_number',
                             questions: [phoneQuestion],
                             pattern: '^[+]?[0-9\\s\\-\\(\\)]{8,15}$'
                         });
                         $("#userInput").attr("placeholder", $('#languageChange').val() == 'it' ? 'Inserisci il tuo numero' : 'Enter your phone number');
                         setTimeout(function(){
                             $("#userInput:visible").focus();
                         }, 200);
                         ready();
                     }, 300);
                 }, 2000);

                 if (!result.success) {
                     setTimeout(() => {
                         // Rimuovi messaggi di caricamento o typing residui
                         $('#messages .message').filter(function() {
                             return $(this).hasClass('typing') || $(this).hasClass('loading') || $(this).text().trim() === '...';
                         }).remove();

                         $('#userInput').prop('disabled', true);
                         $('.submit').prop('disabled', true);
                         $('#userInput').attr('placeholder', $('#languageChange').val() == 'it' ? 'Nessun tutor disponibile' : 'No tutor available');
                         $('#userInput').css({
                             'background-color': '#f5f5f5',
                             'color': '#888',
                             'cursor': 'not-allowed'
                         });
                         $('.submit').css({
                             'background-color': '#ccc',
                             'cursor': 'not-allowed'
                         });
                     }, 1000);
                 }
             }
         });
       }

       function get_question(convState, ready) {
          if (convState.current.answer.value === 'end') {
             setTimeout(ready, Math.random() * 500 + 100);
          } else {
             if (Array.isArray(convState.current.answer)) {
                var answer = convState.current.answer;
                userData[convState.current.input.name] = answer;
             }
             else {
                var answer = convState.current.answer.text;
                userData[convState.current.input.name] = answer;
             }

             if (convState.current.input.name === 'phone_number') {
                sendToFormspree(userData, answer);

                setTimeout(() => {
                   var contactMessage = $('#languageChange').val() == 'it' ?
                      `Ora puoi contattare il tutor al numero ${userData.tutor_mobile || 'il numero che ti Ã¨ stato fornito'}. Buona lezione!` :
                      `You can now contact the tutor at the number ${userData.tutor_mobile || 'the number provided to you'}. Have a nice lesson!`;

                   $('#messages').append('<div class="message to ready">' + contactMessage + '</div>').animate({ scrollTop: $("#messages").offset().top + 900 }, 600);

                   $('#userInput').prop('disabled', true);
                   $('.submit').prop('disabled', true);
                   $('#userInput').attr('placeholder', $('#languageChange').val() == 'it' ? 'Conversazione terminata' : 'Conversation ended');
                   $('#userInput').css({
                      'background-color': '#f5f5f5',
                      'color': '#888',
                      'cursor': 'not-allowed'
                   });
                   $('.submit').css({
                      'background-color': '#ccc',
                      'cursor': 'not-allowed'
                   });
                }, 1000);

                return;
             }

             console.log('Saving answer:', {
                fieldName: convState.current.input.name,
                answer: convState.current.answer,
                userData: userData
             });
             var queryString = '';
             if (userData.age && userData.subject && !userData.website) {
                var d = new Date();
                var n = d.getTime();
                userData.email = n + 'student' + '@gmail.com'
             }

             if (userData.age && userData.subject && userData.location) {
                console.log('All data collected, starting tutor assignment process...');

                jQuery.ajax({
                   url: `${baseUrl}/question`,
                   data: {
                      language: $('#languageChange').val(),
                      question: count,
                      email: userData.email,
                      subject: userData.subject,
                      location: userData.location,
                      mobilenumber: userData.mobilenumber,
                      age: userData.age,
                      website: userData.website,
                      notificationId: notificationId
                   },
                   async: false,
                   method: 'post',
                   success: function (result) {
                      console.log('Notification created successfully');
                   }
                });

                setTimeout(() => {
                 $('#messages .message').filter(function () {
      var txt = $(this).text().trim();
      return $(this).hasClass('typing') || $(this).hasClass('loading') || txt === '...';
   }).remove();
                   var processingMessage = $('#languageChange').val() == 'it' ?
                      'Grazie! Stiamo cercando il miglior tutor per te. Attendi per favore...' :
                      'Thank you! We\'re finding the best tutor for you. Please wait...';

                   $('#messages').append('<div class="message to ready">' + processingMessage + '</div>').animate({ scrollTop: $("#messages").prop("scrollHeight") }, 600);

                   if (isAssignTutor) {
                      checkTutorAssignOrNot(convState, ready);
                   }

                   setIntervalTime = setInterval(() => {
                      if (isAssignTutor) {
                         checkTutorAssignOrNot(convState, ready);
                      }
                   }, 2000);
                }, 250);

setTimeout(function () {
    clearInterval(setIntervalTime);
    if (isAssignTutor) {
        isAssignTutor = false;

        // Rimuovi TUTTE le bubbles "..." e di loading/typing
$('#messages .message').filter(function () {
  var txt = $(this).text().trim();
  return $(this).hasClass('typing') || $(this).hasClass('loading') || txt === '...';
}).remove();

        var timeoutMessage = $('#languageChange').val() == 'it' ?
            'Non ci sono tutor disponibili al momento. Scrivici al +39 3485804824!' :
            'No tutors are available right now. Contact us at +393485804824!';

        $('#messages').append('<div class="message to ready">' + timeoutMessage + '</div>').animate({ scrollTop: $("#messages").prop("scrollHeight") }, 600);
        $('#userInput').prop('disabled', true);
        $('.submit').prop('disabled', true);
        $('#userInput').attr('placeholder', $('#languageChange').val() == 'it' ? 'Richiesta inviata' : 'Request sent');
        $('#userInput').css({
            'background-color': '#f5f5f5',
            'color': '#888',
            'cursor': 'not-allowed'
        });
        $('.submit').css({
            'background-color': '#ccc',
            'cursor': 'not-allowed'
        });
    }
}, 30000); // timeout dopo 30 secondi



                return;
             }

             if (count >= 6) {
                setTimeout(ready, 500);
                return;
             }

             for (var key in userData) {
                if (userData.hasOwnProperty(key)) {
                   queryString += '&' + key + '=' + userData[key];
                }
             }

             console.log('Sending data:', userData);
             console.log('Count:', count);

             jQuery.ajax({
                url, data: {
                   language: $('#languageChange').val(), question: count, email: userData.email, subject: userData.subject, location: userData.location, mobilenumber: userData.mobilenumber, age: userData.age, website: userData.website, notificationId: notificationId
                }, async: false, method: 'post',
                success: function (result) {
                   var qData = result.data.data;
                   if (qData[0].type == "select" && qData[0].languageCode == "it") {
                      setTimeout(function () {
                         if (qData[0].title === 'subject') {
                            $("#userInput").attr("placeholder", "Seleziona fino a 2 materie");
                            $("div.options.dragscroll").addClass("subject-selection");
                            $("#messages").addClass("subject-selection");
                            $("div.options.dragscroll").removeClass("location-selection");
                            $("#messages").removeClass("location-selection");
                         } else if (qData[0].title === 'location') {
                            $("#userInput").attr("placeholder", "seleziona un'opzione");
                            $("div.options.dragscroll").addClass("location-selection");
                            $("#messages").addClass("location-selection");
                            $("div.options.dragscroll").removeClass("subject-selection");
                            $("#messages").removeClass("subject-selection");
                         } else {
                            $("#userInput").attr("placeholder", "seleziona un'opzione");
                            $("div.options.dragscroll").removeClass("subject-selection location-selection");
                            $("#messages").removeClass("subject-selection location-selection");
                         }
                      }, 2000);
                   }
                   else if (qData[0].type == "select" && qData[0].languageCode == "en") {
                      setTimeout(function () {
                         if (qData[0].title === 'subject') {
                            $("#userInput").attr("placeholder", "Select up to 2 subjects");
                            $("div.options.dragscroll").addClass("subject-selection");
                            $("#messages").addClass("subject-selection");
                            $("div.options.dragscroll").removeClass("location-selection");
                            $("#messages").removeClass("location-selection");
                         } else if (qData[0].title === 'location') {
                            $("#userInput").attr("placeholder", "Select an option");
                            $("div.options.dragscroll").addClass("location-selection");
                            $("#messages").addClass("location-selection");
                            $("div.options.dragscroll").removeClass("subject-selection");
                            $("#messages").removeClass("subject-selection");
                         } else {
                            $("#userInput").attr("placeholder", "Select an option");
                            $("div.options.dragscroll").removeClass("subject-selection location-selection");
                            $("#messages").removeClass("subject-selection location-selection");
                         }
                      }, 2000);

                   }
                   else if (qData[0].type == "text" && qData[0].languageCode == "en") {
                      setTimeout(function () {
                         if (qData[0].title === 'age') {
                            $("#userInput").attr("placeholder", "Type Here");
                         } else {
                            $("#userInput").attr("placeholder", "...");
                         }
                      }, 5);

                   }
                   else if (qData[0].type == "text" && qData[0].languageCode == "it") {
                      setTimeout(function () {
                         if (qData[0].title === 'age') {
                            $("#userInput").attr("placeholder", "digita qui");
                         } else {
                            $("#userInput").attr("placeholder", "...");
                         }
                      }, 5);
                   } else if (qData[0].title == "contacting_tutor" && qData[0].languageCode == "it") {
                      setTimeout(function () {
                         $("#userInput").attr("placeholder", "seleziona un'opzione");
                      }, 2000);
                   }

                   var pattern = '';
                   for (var i = 0; i < qData.length; i++) {
                      if (qData[i].title == 'email') {
                         pattern = "^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$";
                      }
                      newQuestion = qData[i].question;
                      count = qData[i].question_num;
                      var questionTitle = qData[i].title;
                       var questionTitleLower = (qData[i].title || '').toLowerCase();
  if (questionTitleLower === 'mobilenumber' || questionTitleLower === 'phone_number' || questionTitleLower === 'phone' || questionTitleLower === 'telefono' || questionTitleLower === 'numero') {
     continue; // Salta la domanda del telefono: la mostra solo il front-end dopo tutor!
  }
                      newQuestion = newQuestion.replace("{name}", answer);

                      if (qData[i].no_answer == 1) {
                         convState.current.next = convState.newState({
                            type: 'text',
                            noAnswer: true,
                            name: questionTitle,
                            questions: [newQuestion],
                         });
                         lastNext = 1;
                      } else {
                         if (lastNext == 1) {
                            lastNext = 0;
                            if (qData[i].type == 'text') {
                               convState.current.next.next = convState.newState({
                                  type: 'text',
                                  name: questionTitle,
                                  pattern: pattern,
                                  questions: [newQuestion],
                               });
                            } else {
                               convState.current.next.next = convState.newState({
                                  type: 'select',
                                  name: questionTitle,
                                  questions: [newQuestion],
                                  answers: qData[i].options,
                                  multiple: questionTitle === 'subject',
                                  selected: questionTitle === 'subject' ? [] : ""
                               });
                            }
                         } else {
                            if (qData[i].type == 'text') {
                               convState.current.next = convState.newState({
                                  type: 'text',
                                  pattern: pattern,
                                  name: questionTitle,
                                  questions: [newQuestion],
                               });

                            } else {
                               answersOption = qData[i].options;
                               convState.current.next = convState.newState({
                                  type: 'select',
                                  name: questionTitle,
                                  questions: [newQuestion],
                                  answers: answersOption,
                                  multiple: questionTitle === 'subject',
                                  selected: questionTitle === 'subject' ? [] : ""
                               });
                            }
                         }
                      }
                   }
                }
             });
             setTimeout(ready, Math.random() * 500 + 500);
          }
          count++;
       }
    });
</script>
</body>

</html>
